# FastAPI é¡¹ç›®æ¦‚è§ˆ

## ğŸ¯ é¡¹ç›®ç›®æ ‡

é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·ç®¡ç†ç³»ç»Ÿï¼Œå­¦ä¹  FastAPIã€SQLAlchemy å’Œ Pydantic çš„æ ¸å¿ƒæ¦‚å¿µå’Œæœ€ä½³å®è·µã€‚

## ğŸ“ é¡¹ç›®æ¶æ„

### ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          API å±‚ (FastAPI)               â”‚
â”‚  - è·¯ç”±å®šä¹‰                              â”‚
â”‚  - è¯·æ±‚å¤„ç†                              â”‚
â”‚  - å“åº”æ ¼å¼åŒ–                            â”‚
â”‚  - ä½¿ç”¨ Pydantic Schemas                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä¸šåŠ¡é€»è¾‘å±‚ (CRUD)                â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘                              â”‚
â”‚  - æ•°æ®éªŒè¯                              â”‚
â”‚  - äº‹åŠ¡å¤„ç†                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       æ•°æ®å±‚ (SQLAlchemy Models)        â”‚
â”‚  - ORM æ¨¡å‹                             â”‚
â”‚  - æ•°æ®åº“è¡¨å®šä¹‰                          â”‚
â”‚  - å…³ç³»å®šä¹‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆè¦åˆ†å±‚ï¼Ÿ

1. **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šæ¯å±‚åªå…³æ³¨è‡ªå·±çš„èŒè´£
2. **æ˜“äºæµ‹è¯•**ï¼šå¯ä»¥ç‹¬ç«‹æµ‹è¯•æ¯ä¸€å±‚
3. **ä»£ç å¤ç”¨**ï¼šCRUD å±‚å¯ä»¥åœ¨å¤šä¸ªç«¯ç‚¹ä¸­å¤ç”¨
4. **æ˜“äºç»´æŠ¤**ï¼šä¿®æ”¹ä¸€å±‚ä¸å½±å“å…¶ä»–å±‚

## ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µ

### 1. Models vs Schemas

| ç‰¹æ€§ | SQLAlchemy Models | Pydantic Schemas |
|------|-------------------|------------------|
| ç”¨é€” | æ•°æ®åº“è¡¨ç»“æ„ | API æ•°æ®éªŒè¯ |
| ç»§æ‰¿ | `Base` | `BaseModel` |
| å­—æ®µå®šä¹‰ | `mapped_column()` | `Field()` |
| éªŒè¯ | æ•°æ®åº“çº¦æŸ | Python ç±»å‹+éªŒè¯å™¨ |
| åºåˆ—åŒ– | éœ€è¦æ‰‹åŠ¨ | è‡ªåŠ¨ |

**ç¤ºä¾‹ï¼š**

```python
# Model (æ•°æ®åº“å±‚)
class User(Base):
    __tablename__ = "users"
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    email: Mapped[str] = mapped_column(String, unique=True)

# Schema (API å±‚)
class UserCreate(BaseModel):
    email: EmailStr = Field(..., description="ç”¨æˆ·é‚®ç®±")
```

### 2. ä¾èµ–æ³¨å…¥ (Dependency Injection)

FastAPI çš„æ ¸å¿ƒç‰¹æ€§ï¼Œç”¨äºï¼š
- å¤ç”¨é€»è¾‘
- æé«˜å¯æµ‹è¯•æ€§
- ç®¡ç†èµ„æºï¼ˆå¦‚æ•°æ®åº“è¿æ¥ï¼‰

**åŸºæœ¬ç”¨æ³•ï¼š**

```python
# å®šä¹‰ä¾èµ–
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# ä½¿ç”¨ä¾èµ–
@app.get("/users/")
def get_users(db: Session = Depends(get_db)):
    return user_crud.get_multi(db)
```

**ä¾èµ–é“¾ï¼š**

```python
# ç¬¬ä¸€å±‚ä¾èµ–
def get_db():
    ...

# ç¬¬äºŒå±‚ä¾èµ–ï¼ˆä¾èµ–äº get_dbï¼‰
def get_current_user(db: Session = Depends(get_db), token: str = Depends(oauth2_scheme)):
    ...

# ç¬¬ä¸‰å±‚ä¾èµ–ï¼ˆä¾èµ–äº get_current_userï¼‰
def get_current_active_user(current_user: User = Depends(get_current_user)):
    ...
```

### 3. CRUD æ¨¡å¼

**C**reate, **R**ead, **U**pdate, **D**elete

- å°†æ•°æ®åº“æ“ä½œå°è£…åœ¨ CRUD ç±»ä¸­
- æä¾›ç»Ÿä¸€çš„æ¥å£
- æ˜“äºæµ‹è¯•å’Œå¤ç”¨

**é€šç”¨åŸºç±»ï¼š**

```python
class CRUDBase(Generic[ModelType, CreateSchemaType, UpdateSchemaType]):
    def get(self, db: Session, id: int) -> ModelType | None
    def get_multi(self, db: Session, skip: int = 0, limit: int = 100) -> list[ModelType]
    def create(self, db: Session, obj_in: CreateSchemaType) -> ModelType
    def update(self, db: Session, db_obj: ModelType, obj_in: UpdateSchemaType) -> ModelType
    def delete(self, db: Session, id: int) -> ModelType | None
```

## ğŸ” è®¤è¯ä¸æˆæƒ

### JWT æµç¨‹

```
1. ç”¨æˆ·ç™»å½•
   â†“
2. éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
   â†“
3. ç”Ÿæˆ JWT token
   â†“
4. è¿”å› token ç»™å®¢æˆ·ç«¯
   â†“
5. å®¢æˆ·ç«¯åœ¨åç»­è¯·æ±‚ä¸­æºå¸¦ token
   â†“
6. æœåŠ¡ç«¯éªŒè¯ token
   â†“
7. è¿”å›å—ä¿æŠ¤çš„èµ„æº
```

### JWT Token ç»“æ„

```
Header.Payload.Signature

Payload åŒ…å«:
{
  "sub": 1,           # subject: ç”¨æˆ· ID
  "exp": 1640000000,  # expiration: è¿‡æœŸæ—¶é—´
  "iat": 1639900000   # issued at: ç­¾å‘æ—¶é—´
}
```

## ğŸ“Š æ•°æ®æµ

### åˆ›å»ºç”¨æˆ·æµç¨‹

```
å®¢æˆ·ç«¯ POST /api/v1/auth/register
    â†“
API ç«¯ç‚¹æ¥æ”¶ UserCreate Schema
    â†“
éªŒè¯æ•°æ®ï¼ˆPydantic è‡ªåŠ¨ï¼‰
    â†“
æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼ˆCRUDï¼‰
    â†“
åˆ›å»ºç”¨æˆ·ï¼ˆCRUDï¼Œå¯†ç å“ˆå¸Œï¼‰
    â†“
ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆSQLAlchemyï¼‰
    â†“
è¿”å› UserResponse Schema
    â†“
å®¢æˆ·ç«¯æ”¶åˆ° JSON å“åº”
```

### è·å–ç”¨æˆ·ä¿¡æ¯æµç¨‹

```
å®¢æˆ·ç«¯ GET /api/v1/auth/me
    â†“
æå– Authorization header ä¸­çš„ token
    â†“
éªŒè¯ tokenï¼ˆä¾èµ–æ³¨å…¥ï¼‰
    â†“
ä» token ä¸­è·å– user_id
    â†“
ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ï¼ˆCRUDï¼‰
    â†“
è½¬æ¢ä¸º Pydantic Schema
    â†“
è¿”å› JSON å“åº”
```

## ğŸ¨ ä»£ç ç»„ç»‡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™

æ¯ä¸ªæ¨¡å—åªåšä¸€ä»¶äº‹ï¼š
- `models/` - åªå®šä¹‰æ•°æ®åº“è¡¨
- `schemas/` - åªå®šä¹‰ API æ•°æ®ç»“æ„
- `crud/` - åªå¤„ç†æ•°æ®åº“æ“ä½œ
- `api/endpoints/` - åªå®šä¹‰è·¯ç”±å’Œå¤„ç†è¯·æ±‚

### 2. ä¾èµ–å€’ç½®åŸåˆ™

é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—ï¼Œéƒ½ä¾èµ–æŠ½è±¡ï¼š
- API å±‚ä¸ç›´æ¥æ“ä½œæ•°æ®åº“
- é€šè¿‡ CRUD å±‚æŠ½è±¡æ•°æ®è®¿é—®
- é€šè¿‡ Schemas æŠ½è±¡æ•°æ®ç»“æ„

### 3. å¼€é—­åŸåˆ™

å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼š
- é€šç”¨ CRUD åŸºç±»å¯æ‰©å±•
- æ–°å¢æ¨¡å‹åªéœ€ç»§æ‰¿åŸºç±»
- æ–°å¢ç«¯ç‚¹åªéœ€æ·»åŠ è·¯ç”±

## ğŸš€ ä¸‹ä¸€æ­¥

1. ç†è§£é¡¹ç›®ç»“æ„å’Œæ–‡ä»¶èŒè´£
2. å­¦ä¹  Models å’Œ Schemas çš„å®šä¹‰
3. æŒæ¡ CRUD æ“ä½œ
4. å®è·µ API ç«¯ç‚¹å¼€å‘
5. ç†è§£è®¤è¯æµç¨‹
6. æ‰©å±•é¡¹ç›®ï¼ˆæ·»åŠ æ–‡ç« ã€è¯„è®ºç­‰åŠŸèƒ½ï¼‰


## ğŸ“ Celery & LLMæ¨èçš„ç›®å½•ç»“æ„

### **Celery å¼‚æ­¥ä»»åŠ¡**

```bash
app/
â”œâ”€â”€ tasks/                  # Celery ä»»åŠ¡ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ user_tasks.py      # ç”¨æˆ·ç›¸å…³ä»»åŠ¡
â”‚   â”œâ”€â”€ email_tasks.py     # é‚®ä»¶ä»»åŠ¡
â”‚   â””â”€â”€ llm_tasks.py       # LLM ç›¸å…³ä»»åŠ¡
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ celery.py          # Celery é…ç½®å’Œå®ä¾‹
â”‚   â””â”€â”€ ...
â””â”€â”€ worker.py              # Celery Worker å…¥å£ï¼ˆå¯é€‰ï¼‰
```

### **LLM è°ƒç”¨**

```bash
app/
â”œâ”€â”€ services/              # ä¸šåŠ¡æœåŠ¡å±‚ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ llm/              # LLM æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py       # LLM åŸºç±»/æ¥å£
â”‚   â”‚   â”œâ”€â”€ openai.py     # OpenAI å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ claude.py     # Claude å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ prompts/      # æç¤ºè¯æ¨¡æ¿
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ templates.py
â”‚   â””â”€â”€ email.py          # é‚®ä»¶æœåŠ¡ï¼ˆç¤ºä¾‹ï¼‰
```

## ğŸ“‹ å®Œæ•´å»ºè®®ç»“æ„

```bash
fastapi-learning/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/              # ç°æœ‰ï¼šAPI è·¯ç”±
â”‚   â”œâ”€â”€ core/             # ç°æœ‰ï¼šæ ¸å¿ƒé…ç½®
â”‚   â”‚   â”œâ”€â”€ celery.py     # æ–°å¢ï¼šCelery é…ç½®
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ crud/             # ç°æœ‰ï¼šæ•°æ®åº“æ“ä½œ
â”‚   â”œâ”€â”€ models/           # ç°æœ‰ï¼šSQLAlchemy æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/          # ç°æœ‰ï¼šPydantic æ¨¡å‹
â”‚   â”œâ”€â”€ tasks/            # æ–°å¢ï¼šCelery ä»»åŠ¡
â”‚   â”œâ”€â”€ services/         # æ–°å¢ï¼šä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”‚   â””â”€â”€ llm/         # LLM ç›¸å…³æœåŠ¡
â”‚   â””â”€â”€ utils/            # æ–°å¢ï¼šå·¥å…·å‡½æ•°ï¼ˆå¯é€‰ï¼‰
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### 1. Celery é…ç½® (`app/core/celery.py`)

```python
from celery import Celery
from app.core.config import settings

celery_app = Celery(
    "worker",
    broker=settings.CELERY_BROKER_URL,
    backend=settings.CELERY_RESULT_BACKEND,
)

celery_app.conf.task_routes = {
    "app.tasks.llm_tasks.*": "llm-queue",
    "app.tasks.email_tasks.*": "email-queue",
}
```

### 2. LLM æœåŠ¡ (`app/services/llm/openai.py`)

```python
from openai import AsyncOpenAI

class OpenAIService:
    def __init__(self):
        self.client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)
    
    async def chat(self, messages: list):
        response = await self.client.chat.completions.create(...)
        return response
```

### 3. LLM ä»»åŠ¡ (`app/tasks/llm_tasks.py`)

```python
from app.core.celery import celery_app
from app.services.llm.openai import OpenAIService

@celery_app.task
def process_with_llm(text: str):
    service = OpenAIService()
    result = service.chat([{"role": "user", "content": text}])
    return result
```

### 4. API ä¸­è°ƒç”¨ (`app/api/v1/endpoints/ai.py`)

```python
from app.services.llm.openai import OpenAIService
from app.tasks.llm_tasks import process_with_llm

@router.post("/chat")
async def chat(message: str):
    # åŒæ­¥è°ƒç”¨
    service = OpenAIService()
    result = await service.chat([...])
    
    # æˆ–å¼‚æ­¥ä»»åŠ¡
    task = process_with_llm.delay(message)
    return {"task_id": task.id}
```
# FastAPI 学习总结

## 🎯 项目成果

✅ 完整的 FastAPI + SQLAlchemy + Pydantic 项目
✅ 标准的三层架构设计
✅ JWT 认证和授权系统
✅ RESTful API 设计
✅ 完整的文档和示例

## 📊 核心知识点总结

### 1. 项目架构

```
┌─────────────────────┐
│   API 层 (FastAPI)  │ ← 路由、请求处理、响应格式化
├─────────────────────┤
│   Schemas (Pydantic)│ ← 数据验证、序列化
├─────────────────────┤
│   CRUD 层           │ ← 业务逻辑、数据操作
├─────────────────────┤
│   Models (SQLAlchemy)│ ← ORM、数据库表定义
└─────────────────────┘
```

**设计原则：**
- 分层明确，职责单一
- 高内聚，低耦合
- 易于测试和维护

### 2. SQLAlchemy Models

**核心概念：**
- ORM：对象关系映射
- `Mapped` 和 `mapped_column`：类型化的列定义
- 索引和约束：提高查询性能
- 时间戳：自动管理创建和更新时间

**关键代码：**
```python
class User(Base):
    __tablename__ = "users"
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    email: Mapped[str] = mapped_column(String, unique=True, index=True)
```

### 3. Pydantic Schemas

**核心概念：**
- 数据验证：自动验证请求数据
- 序列化：自动转换为 JSON
- 文档生成：自动生成 API 文档

**Schema 类型：**
- `BaseSchema`：共享字段
- `CreateSchema`：创建时的输入（所有字段必填）
- `UpdateSchema`：更新时的输入（所有字段可选）
- `ResponseSchema`：返回给客户端（不含敏感信息）

**关键配置：**

```python
model_config = ConfigDict(from_attributes=True)  # 从 ORM 对象创建
```

### 4. CRUD 层

**核心概念：**

- 泛型基类：复用代码
- 业务逻辑：封装数据操作
- 事务处理：确保数据一致性

**CRUD 操作：**

- `get(id)` - 获取单个对象
- `get_multi(skip, limit)` - 分页获取
- `create(obj_in)` - 创建对象
- `update(db_obj, obj_in)` - 更新对象
- `delete(id)` - 删除对象

**关键技巧：**

```python
update_data = obj_in.model_dump(exclude_unset=True)  # 只更新提供的字段
```

### 5. API 层（FastAPI）

**核心概念：**

- 路由装饰器：`@router.get/post/put/delete`
- 路径参数：`{user_id}`
- 查询参数：`?page=1&page_size=10`
- 请求体：Pydantic Schema
- 响应模型：`response_model=UserResponse`

**依赖注入：**

```python
DBSession = Annotated[Session, Depends(get_db)]
CurrentUser = Annotated[User, Depends(get_current_user)]

@router.get("/me")
def get_me(current_user: CurrentUser):
    return current_user
```

### 6. JWT 认证

**认证流程：**

1. 用户登录 → 验证用户名和密码
2. 生成 JWT token
3. 返回 token 给客户端
4. 客户端在后续请求中携带 token
5. 服务端验证 token
6. 返回受保护的资源

**JWT 结构：**
```
Header.Payload.Signature
```

**关键函数：**

```python
# 创建 token
create_access_token(user_id)

# 验证 token
jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
```

## 🔑 最佳实践清单

### 项目结构

✅ 按功能模块组织代码
✅ 明确分离 models、schemas、crud
✅ 使用路由前缀和标签

### SQLAlchemy

✅ 使用 `Mapped` 和 `mapped_column`
✅ 添加索引提高查询性能
✅ 使用 `server_default` 设置默认值
✅ 实现 `__repr__` 方便调试

### Pydantic

✅ 为不同用途创建不同的 Schema
✅ 使用 `Field` 添加验证和文档
✅ 使用 `exclude_unset=True` 更新数据
✅ 永远不要返回敏感信息（密码）

### CRUD

✅ 使用泛型基类避免重复
✅ 所有数据库操作在 CRUD 层完成
✅ 使用类型提示
✅ 处理事务和异常

### API

✅ 使用依赖注入获取数据库会话
✅ 明确指定 `response_model`
✅ 使用正确的 HTTP 状态码
✅ 添加详细的描述和标签

### 安全

✅ 使用 bcrypt 哈希密码
✅ 使用 JWT 进行认证
✅ 密钥存储在环境变量中
✅ 实现权限检查
✅ 设置合理的 token 过期时间

## 📈 进阶学习方向

### 1. 数据库关系

**一对多：**
```python
class User(Base):
    posts: Mapped[list["Post"]] = relationship("Post")

class Post(Base):
    user_id: Mapped[int] = mapped_column(ForeignKey("users.id"))
    author: Mapped["User"] = relationship("User")
```

**多对多：**
```python
post_tags = Table("post_tags", Base.metadata,
    Column("post_id", ForeignKey("posts.id")),
    Column("tag_id", ForeignKey("tags.id"))
)
```

### 2. 异步 FastAPI

```python
@router.get("/users/")
async def get_users(db: AsyncSession = Depends(get_async_db)):
    result = await db.execute(select(User))
    return result.scalars().all()
```

### 3. 数据库迁移（Alembic）

```bash
# 初始化
alembic init alembic

# 创建迁移
alembic revision --autogenerate -m "Add users table"

# 应用迁移
alembic upgrade head
```

### 4. 单元测试

```python
from fastapi.testclient import TestClient

def test_create_user():
    response = client.post("/api/v1/auth/register", json={
        "email": "test@example.com",
        "username": "testuser",
        "password": "password123"
    })
    assert response.status_code == 201
```

### 5. 后台任务

```python
from fastapi import BackgroundTasks

@router.post("/send-email/")
async def send_email(background_tasks: BackgroundTasks):
    background_tasks.add_task(send_email_task, email="user@example.com")
    return {"message": "Email will be sent"}
```

### 6. WebSocket

```python
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    while True:
        data = await websocket.receive_text()
        await websocket.send_text(f"Message: {data}")
```

### 7. 中间件

```python
@app.middleware("http")
async def add_process_time_header(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    process_time = time.time() - start_time
    response.headers["X-Process-Time"] = str(process_time)
    return response
```

### 8. 分页和过滤

```python
from fastapi_pagination import Page, add_pagination, paginate

@router.get("/users/", response_model=Page[UserResponse])
def get_users(db: DBSession):
    users = user_crud.get_multi(db)
    return paginate(users)

add_pagination(app)
```

## 🎓 学习资源

### 官方文档

- [FastAPI](https://fastapi.tiangolo.com/)
- [Pydantic V2](https://docs.pydantic.dev/latest/)
- [SQLAlchemy 2.0](https://docs.sqlalchemy.org/en/20/)

### 推荐项目

- [FastAPI Best Practices](https://github.com/zhanymkanov/fastapi-best-practices)
- [Full Stack FastAPI Template](https://github.com/tiangolo/full-stack-fastapi-template)
- [Awesome FastAPI](https://github.com/mjhea0/awesome-fastapi)

### 书籍

- "FastAPI 实战"
- "Building Data Science Applications with FastAPI"

## 🏆 学习成就

通过本项目，你已经掌握：

✅ FastAPI 框架的核心概念和用法
✅ SQLAlchemy ORM 的使用
✅ Pydantic V2 数据验证
✅ JWT 认证和授权
✅ RESTful API 设计原则
✅ 三层架构设计模式
✅ 依赖注入模式
✅ 现代 Python 类型系统

## 🚀 下一步行动

1. **巩固基础**
   - 重复练习 CRUD 操作
   - 理解每一层的职责
   - 熟练使用类型提示

2. **扩展功能**
   - 添加文章系统
   - 实现评论功能
   - 添加标签系统
   - 实现文件上传

3. **提升技能**
   - 学习异步编程
   - 掌握数据库迁移
   - 编写单元测试
   - 学习 Docker 部署

4. **实战项目**
   - 构建个人博客 API
   - 开发在线商城后端
   - 创建社交媒体平台

## 💡 学习心得记录

在这里记录你的学习心得和遇到的问题：

---

**日期：** _______

**学到的知识：**
- 

**遇到的问题：**
- 

**解决方案：**
- 

---

继续加油！🎉


# FastAPI å­¦ä¹ æ€»ç»“

## ğŸ¯ é¡¹ç›®æˆæœ

âœ… å®Œæ•´çš„ FastAPI + SQLAlchemy + Pydantic é¡¹ç›®
âœ… æ ‡å‡†çš„ä¸‰å±‚æ¶æ„è®¾è®¡
âœ… JWT è®¤è¯å’Œæˆæƒç³»ç»Ÿ
âœ… RESTful API è®¾è®¡
âœ… å®Œæ•´çš„æ–‡æ¡£å’Œç¤ºä¾‹

## ğŸ“Š æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»ç»“

### 1. é¡¹ç›®æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API å±‚ (FastAPI)  â”‚ â† è·¯ç”±ã€è¯·æ±‚å¤„ç†ã€å“åº”æ ¼å¼åŒ–
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Schemas (Pydantic)â”‚ â† æ•°æ®éªŒè¯ã€åºåˆ—åŒ–
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   CRUD å±‚           â”‚ â† ä¸šåŠ¡é€»è¾‘ã€æ•°æ®æ“ä½œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Models (SQLAlchemy)â”‚ â† ORMã€æ•°æ®åº“è¡¨å®šä¹‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡åŸåˆ™ï¼š**
- åˆ†å±‚æ˜ç¡®ï¼ŒèŒè´£å•ä¸€
- é«˜å†…èšï¼Œä½è€¦åˆ
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

### 2. SQLAlchemy Models

**æ ¸å¿ƒæ¦‚å¿µï¼š**
- ORMï¼šå¯¹è±¡å…³ç³»æ˜ å°„
- `Mapped` å’Œ `mapped_column`ï¼šç±»å‹åŒ–çš„åˆ—å®šä¹‰
- ç´¢å¼•å’Œçº¦æŸï¼šæé«˜æŸ¥è¯¢æ€§èƒ½
- æ—¶é—´æˆ³ï¼šè‡ªåŠ¨ç®¡ç†åˆ›å»ºå’Œæ›´æ–°æ—¶é—´

**å…³é”®ä»£ç ï¼š**
```python
class User(Base):
    __tablename__ = "users"
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    email: Mapped[str] = mapped_column(String, unique=True, index=True)
```

### 3. Pydantic Schemas

**æ ¸å¿ƒæ¦‚å¿µï¼š**
- æ•°æ®éªŒè¯ï¼šè‡ªåŠ¨éªŒè¯è¯·æ±‚æ•°æ®
- åºåˆ—åŒ–ï¼šè‡ªåŠ¨è½¬æ¢ä¸º JSON
- æ–‡æ¡£ç”Ÿæˆï¼šè‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£

**Schema ç±»å‹ï¼š**
- `BaseSchema`ï¼šå…±äº«å­—æ®µ
- `CreateSchema`ï¼šåˆ›å»ºæ—¶çš„è¾“å…¥ï¼ˆæ‰€æœ‰å­—æ®µå¿…å¡«ï¼‰
- `UpdateSchema`ï¼šæ›´æ–°æ—¶çš„è¾“å…¥ï¼ˆæ‰€æœ‰å­—æ®µå¯é€‰ï¼‰
- `ResponseSchema`ï¼šè¿”å›ç»™å®¢æˆ·ç«¯ï¼ˆä¸å«æ•æ„Ÿä¿¡æ¯ï¼‰

**å…³é”®é…ç½®ï¼š**

```python
model_config = ConfigDict(from_attributes=True)  # ä» ORM å¯¹è±¡åˆ›å»º
```

### 4. CRUD å±‚

**æ ¸å¿ƒæ¦‚å¿µï¼š**

- æ³›å‹åŸºç±»ï¼šå¤ç”¨ä»£ç 
- ä¸šåŠ¡é€»è¾‘ï¼šå°è£…æ•°æ®æ“ä½œ
- äº‹åŠ¡å¤„ç†ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§

**CRUD æ“ä½œï¼š**

- `get(id)` - è·å–å•ä¸ªå¯¹è±¡
- `get_multi(skip, limit)` - åˆ†é¡µè·å–
- `create(obj_in)` - åˆ›å»ºå¯¹è±¡
- `update(db_obj, obj_in)` - æ›´æ–°å¯¹è±¡
- `delete(id)` - åˆ é™¤å¯¹è±¡

**å…³é”®æŠ€å·§ï¼š**

```python
update_data = obj_in.model_dump(exclude_unset=True)  # åªæ›´æ–°æä¾›çš„å­—æ®µ
```

### 5. API å±‚ï¼ˆFastAPIï¼‰

**æ ¸å¿ƒæ¦‚å¿µï¼š**

- è·¯ç”±è£…é¥°å™¨ï¼š`@router.get/post/put/delete`
- è·¯å¾„å‚æ•°ï¼š`{user_id}`
- æŸ¥è¯¢å‚æ•°ï¼š`?page=1&page_size=10`
- è¯·æ±‚ä½“ï¼šPydantic Schema
- å“åº”æ¨¡å‹ï¼š`response_model=UserResponse`

**ä¾èµ–æ³¨å…¥ï¼š**

```python
DBSession = Annotated[Session, Depends(get_db)]
CurrentUser = Annotated[User, Depends(get_current_user)]

@router.get("/me")
def get_me(current_user: CurrentUser):
    return current_user
```

### 6. JWT è®¤è¯

**è®¤è¯æµç¨‹ï¼š**

1. ç”¨æˆ·ç™»å½• â†’ éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
2. ç”Ÿæˆ JWT token
3. è¿”å› token ç»™å®¢æˆ·ç«¯
4. å®¢æˆ·ç«¯åœ¨åç»­è¯·æ±‚ä¸­æºå¸¦ token
5. æœåŠ¡ç«¯éªŒè¯ token
6. è¿”å›å—ä¿æŠ¤çš„èµ„æº

**JWT ç»“æ„ï¼š**
```
Header.Payload.Signature
```

**å…³é”®å‡½æ•°ï¼š**

```python
# åˆ›å»º token
create_access_token(user_id)

# éªŒè¯ token
jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
```

## ğŸ”‘ æœ€ä½³å®è·µæ¸…å•

### é¡¹ç›®ç»“æ„

âœ… æŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡ä»£ç 
âœ… æ˜ç¡®åˆ†ç¦» modelsã€schemasã€crud
âœ… ä½¿ç”¨è·¯ç”±å‰ç¼€å’Œæ ‡ç­¾

### SQLAlchemy

âœ… ä½¿ç”¨ `Mapped` å’Œ `mapped_column`
âœ… æ·»åŠ ç´¢å¼•æé«˜æŸ¥è¯¢æ€§èƒ½
âœ… ä½¿ç”¨ `server_default` è®¾ç½®é»˜è®¤å€¼
âœ… å®ç° `__repr__` æ–¹ä¾¿è°ƒè¯•

### Pydantic

âœ… ä¸ºä¸åŒç”¨é€”åˆ›å»ºä¸åŒçš„ Schema
âœ… ä½¿ç”¨ `Field` æ·»åŠ éªŒè¯å’Œæ–‡æ¡£
âœ… ä½¿ç”¨ `exclude_unset=True` æ›´æ–°æ•°æ®
âœ… æ°¸è¿œä¸è¦è¿”å›æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ï¼‰

### CRUD

âœ… ä½¿ç”¨æ³›å‹åŸºç±»é¿å…é‡å¤
âœ… æ‰€æœ‰æ•°æ®åº“æ“ä½œåœ¨ CRUD å±‚å®Œæˆ
âœ… ä½¿ç”¨ç±»å‹æç¤º
âœ… å¤„ç†äº‹åŠ¡å’Œå¼‚å¸¸

### API

âœ… ä½¿ç”¨ä¾èµ–æ³¨å…¥è·å–æ•°æ®åº“ä¼šè¯
âœ… æ˜ç¡®æŒ‡å®š `response_model`
âœ… ä½¿ç”¨æ­£ç¡®çš„ HTTP çŠ¶æ€ç 
âœ… æ·»åŠ è¯¦ç»†çš„æè¿°å’Œæ ‡ç­¾

### å®‰å…¨

âœ… ä½¿ç”¨ bcrypt å“ˆå¸Œå¯†ç 
âœ… ä½¿ç”¨ JWT è¿›è¡Œè®¤è¯
âœ… å¯†é’¥å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­
âœ… å®ç°æƒé™æ£€æŸ¥
âœ… è®¾ç½®åˆç†çš„ token è¿‡æœŸæ—¶é—´

## ğŸ“ˆ è¿›é˜¶å­¦ä¹ æ–¹å‘

### 1. æ•°æ®åº“å…³ç³»

**ä¸€å¯¹å¤šï¼š**
```python
class User(Base):
    posts: Mapped[list["Post"]] = relationship("Post")

class Post(Base):
    user_id: Mapped[int] = mapped_column(ForeignKey("users.id"))
    author: Mapped["User"] = relationship("User")
```

**å¤šå¯¹å¤šï¼š**
```python
post_tags = Table("post_tags", Base.metadata,
    Column("post_id", ForeignKey("posts.id")),
    Column("tag_id", ForeignKey("tags.id"))
)
```

### 2. å¼‚æ­¥ FastAPI

```python
@router.get("/users/")
async def get_users(db: AsyncSession = Depends(get_async_db)):
    result = await db.execute(select(User))
    return result.scalars().all()
```

### 3. æ•°æ®åº“è¿ç§»ï¼ˆAlembicï¼‰

```bash
# åˆå§‹åŒ–
alembic init alembic

# åˆ›å»ºè¿ç§»
alembic revision --autogenerate -m "Add users table"

# åº”ç”¨è¿ç§»
alembic upgrade head
```

### 4. å•å…ƒæµ‹è¯•

```python
from fastapi.testclient import TestClient

def test_create_user():
    response = client.post("/api/v1/auth/register", json={
        "email": "test@example.com",
        "username": "testuser",
        "password": "password123"
    })
    assert response.status_code == 201
```

### 5. åå°ä»»åŠ¡

```python
from fastapi import BackgroundTasks

@router.post("/send-email/")
async def send_email(background_tasks: BackgroundTasks):
    background_tasks.add_task(send_email_task, email="user@example.com")
    return {"message": "Email will be sent"}
```

### 6. WebSocket

```python
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    while True:
        data = await websocket.receive_text()
        await websocket.send_text(f"Message: {data}")
```

### 7. ä¸­é—´ä»¶

```python
@app.middleware("http")
async def add_process_time_header(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    process_time = time.time() - start_time
    response.headers["X-Process-Time"] = str(process_time)
    return response
```

### 8. åˆ†é¡µå’Œè¿‡æ»¤

```python
from fastapi_pagination import Page, add_pagination, paginate

@router.get("/users/", response_model=Page[UserResponse])
def get_users(db: DBSession):
    users = user_crud.get_multi(db)
    return paginate(users)

add_pagination(app)
```

## ğŸ“ å­¦ä¹ èµ„æº

### å®˜æ–¹æ–‡æ¡£

- [FastAPI](https://fastapi.tiangolo.com/)
- [Pydantic V2](https://docs.pydantic.dev/latest/)
- [SQLAlchemy 2.0](https://docs.sqlalchemy.org/en/20/)

### æ¨èé¡¹ç›®

- [FastAPI Best Practices](https://github.com/zhanymkanov/fastapi-best-practices)
- [Full Stack FastAPI Template](https://github.com/tiangolo/full-stack-fastapi-template)
- [Awesome FastAPI](https://github.com/mjhea0/awesome-fastapi)

### ä¹¦ç±

- "FastAPI å®æˆ˜"
- "Building Data Science Applications with FastAPI"

## ğŸ† å­¦ä¹ æˆå°±

é€šè¿‡æœ¬é¡¹ç›®ï¼Œä½ å·²ç»æŒæ¡ï¼š

âœ… FastAPI æ¡†æ¶çš„æ ¸å¿ƒæ¦‚å¿µå’Œç”¨æ³•
âœ… SQLAlchemy ORM çš„ä½¿ç”¨
âœ… Pydantic V2 æ•°æ®éªŒè¯
âœ… JWT è®¤è¯å’Œæˆæƒ
âœ… RESTful API è®¾è®¡åŸåˆ™
âœ… ä¸‰å±‚æ¶æ„è®¾è®¡æ¨¡å¼
âœ… ä¾èµ–æ³¨å…¥æ¨¡å¼
âœ… ç°ä»£ Python ç±»å‹ç³»ç»Ÿ

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **å·©å›ºåŸºç¡€**
   - é‡å¤ç»ƒä¹  CRUD æ“ä½œ
   - ç†è§£æ¯ä¸€å±‚çš„èŒè´£
   - ç†Ÿç»ƒä½¿ç”¨ç±»å‹æç¤º

2. **æ‰©å±•åŠŸèƒ½**
   - æ·»åŠ æ–‡ç« ç³»ç»Ÿ
   - å®ç°è¯„è®ºåŠŸèƒ½
   - æ·»åŠ æ ‡ç­¾ç³»ç»Ÿ
   - å®ç°æ–‡ä»¶ä¸Šä¼ 

3. **æå‡æŠ€èƒ½**
   - å­¦ä¹ å¼‚æ­¥ç¼–ç¨‹
   - æŒæ¡æ•°æ®åº“è¿ç§»
   - ç¼–å†™å•å…ƒæµ‹è¯•
   - å­¦ä¹  Docker éƒ¨ç½²

4. **å®æˆ˜é¡¹ç›®**
   - æ„å»ºä¸ªäººåšå®¢ API
   - å¼€å‘åœ¨çº¿å•†åŸåç«¯
   - åˆ›å»ºç¤¾äº¤åª’ä½“å¹³å°

## ğŸ’¡ å­¦ä¹ å¿ƒå¾—è®°å½•

åœ¨è¿™é‡Œè®°å½•ä½ çš„å­¦ä¹ å¿ƒå¾—å’Œé‡åˆ°çš„é—®é¢˜ï¼š

---

**æ—¥æœŸï¼š** _______

**å­¦åˆ°çš„çŸ¥è¯†ï¼š**
- 

**é‡åˆ°çš„é—®é¢˜ï¼š**
- 

**è§£å†³æ–¹æ¡ˆï¼š**
- 

---

ç»§ç»­åŠ æ²¹ï¼ğŸ‰

